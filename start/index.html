<!DOCTYPE html>
<title>Dungee</title>
<meta charset="UTF-8"/>
<nav>
    <a href="/">Home</a>
    <a href="start">Nuevo Dungee</a>
    <a href="play">Jugar un Dungee</a>
</nav>

<div id="lodearribaEl">
    <h1>Nuevo Dungee</h1>
    <button onclick="generarandom()">CREAR NUEVA PARTIDA DUNGEE</button>
    <p id="pinEl"></p>
    <div id="playersEl"></div>
    <button onclick="mostrarPreguntas()">EMPEZAR PARTIDA!</button>
</div>

<div id="preguntasEl"></div>

<script>
    let pin;
    let obtenerUsuariosInterval;

    function generarandom(){
        pin = Math.floor(Math.random()*9000)+1000;
        pinEl.innerText = pin;
        playersEl.innerText = "";

        obtenerUsuariosInterval = setInterval(obtenerUsuarios, 3000);
    }

    function obtenerUsuarios(){
        fetch(`/api/damelosusers?pin=${pin}`)
        .then(string => string.json())
        .then(json => {
            let html = "<ul>";

            for (const x in json.users) {
                html += `<li>${json.users[x].name}</li>`;
            }
            html += "</ul>";

            playersEl.innerHTML = html;
        })
    }

    function mostrarPreguntas() {

        clearInterval(obtenerUsuariosInterval);
        ocultarCosasDeArriba();

        fetch("/api/damelasquestions")
            .then(data =>  data.json())
            .then(questions => {
                let html = "";
                let i = 0;
                for (const pregunta in questions.preguntas){
                    html += `<div id='pregunta${i}' class='oculto'>
                    <h1>${questions.preguntas[pregunta].pregunta}</h1>
                    <ul>
                    <li>${questions.preguntas[pregunta].respuesta0}
                    <li>${questions.preguntas[pregunta].respuesta1}
                    <li>${questions.preguntas[pregunta].respuesta2}
                    <li>${questions.preguntas[pregunta].respuesta3}
                    </ul>
                    </div>`;
                    i++;
                }
                preguntasEl.innerHTML = html;
                irMostrandoPreguntas(i-1);
            });
    }

    function irMostrandoPreguntas(cantidad) {
        let i = 0;
        document.getElementById(`pregunta${i}`).classList.toggle("oculto");
        fetch(`https://dungee-1c560-default-rtdb.europe-west1.firebasedatabase.app/pins/PIN${pin}.json`,{
            method: 'PUT',
            body:`{"pregunta":${i}}`
        });

        const mostrarPreguntasInterval = setInterval(() => {
            document.getElementById(`pregunta${i}`).classList.toggle("oculto");
            i++;
            document.getElementById(`pregunta${i}`).classList.toggle("oculto");
            fetch(`https://dungee-1c560-default-rtdb.europe-west1.firebasedatabase.app/pins/PIN${pin}.json`,{
                method: 'PUT',
                body:`{"pregunta":${i}}`
            });

            if (i == cantidad) {
                clearInterval(mostrarPreguntasInterval);
            }
        }, 3000);
    }


    function ocultarCosasDeArriba(){
        lodearribaEl.classList.toggle("oculto");
    }

</script>



<style> 
.oculto {
    display: none;
}
</style>